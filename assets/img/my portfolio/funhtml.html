<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Uji Statistik - Penempatan Section</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Gochi+Hand&family=Patrick+Hand&display=swap" rel="stylesheet">
    <style>
        /* Define new color variables based on the attached image's aesthetic */
        :root {
            --primary-bg: #101827; /* Very dark blue-grey for body background */
            --chalkboard-bg: #0e141c; /* Darker blue-grey for the board itself */
            --chalkboard-border: #3a4e5a; /* Muted blue-grey for board border */
            --text-color: #e0e7ee; /* Light bluish-grey for general text */
            --card-bg: rgba(18, 30, 45, 0.7); /* Translucent dark blue-grey for cards */
            --card-border: #6ea2b8; /* Muted blue for card borders */
            --input-border: #6ea2b8; /* Muted blue for input borders */
            --button-primary-start: #4a789c; /* Mid-blue for button gradient start */
            --button-primary-end: #3a607e; /* Darker blue for button gradient end */
            --highlight-bg: rgba(110, 162, 184, 0.15); /* Translucent muted blue for highlights */
            --accent-purple: #a7a0de; /* Soft lavender for main accent */
            --accent-gold: #fdd85d; /* Brighter gold/yellow for secondary accent */
            --success-color: #287a55; /* Dark green for success messages */
            --error-color: #9a3a3a; /* Dark red for error messages */
            /* New chart specific colors for better contrast */
            --chart-curve-color: #9dc2d8; /* Lighter blue for primary curve */
            --chart-shading-color: rgba(74, 120, 156, 0.6); /* More opaque, darker blue for shading */
            --chart-observed-z-label: #c2c0ff; /* Lighter purple for observed Z label */
            --chart-critical-z-label: #ffe199; /* Lighter gold for critical Z label */
            --chart-axis-color: #b0c4de; /* Light steel blue for axis */
        }

        body {
            background: linear-gradient(to bottom right, var(--primary-bg), #080d15),
                        url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiPjxkZWZzPjxwYXR0ZXJuIGlkPSJjaGFsayIgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiBwYXR0ZXJuVW5pdHM9InVzZXJTcGFjZU9uVXNlIiBwYXR0ZXJuVHJhbnNmb3JtPSJyb3RhdGUoNDUpIj48cGF0aCBkPSJNIDAgMCBMIDEwIDEwIE0gLTEgNSBMIDYgMTUgTSA1IC0xIEwgMTUgNiIgc3Ryb2tlPSJyZ2JhKDIyNCwyMzEsMjM4LDAuMDcpIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIC8+PC9wYXR0ZXJuPjwvZGVmcz48cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI2NoYWxrKSIgLz48L3N2Zz4=');
            color: var(--text-color);
            font-family: 'Patrick Hand', cursive;
            line-height: 1.6;
        }
        
        .chalkboard {
            background: var(--chalkboard-bg);
            border: 20px solid var(--chalkboard-border);
            border-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="%233a4e5a"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%232c3f4a" stroke-width="3"/></svg>') 40 stretch;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.9);
            position: relative;
            border-radius: 8px;
        }
        
        .chalkboard::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    0deg,
                    rgba(255, 255, 255, 0.03) 0px,
                    rgba(255, 255, 255, 0.03) 1px,
                    transparent 1px,
                    transparent 40px
                ),
                repeating-linear-gradient(
                    90deg,
                    rgba(255, 255, 255, 0.03) 0px,
                    rgba(255, 255, 255, 0.03) 1px,
                    transparent 1px,
                    transparent 40px
                );
            pointer-events: none;
            border-radius: 8px;
        }
        
        h1, h2, h3, h4 {
            font-family: 'Caveat', cursive;
            color: var(--text-color);
            text-shadow: 0 0 4px rgba(255, 255, 255, 0.3);
            letter-spacing: 1px;
        }
        
        .card {
            background: var(--card-bg);
            border: 3px solid var(--card-border);
            border-radius: 8px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            position: relative;
        }
        
        .card::after {
            content: "";
            position: absolute;
            top: 6px;
            left: 6px;
            right: 6px;
            bottom: 6px;
            border: 1px dashed rgba(110, 162, 184, 0.25); /* Adjusted from #64e6b4 to new card border color */
            border-radius: 5px;
            pointer-events: none;
        }
        
        input, select, button {
            font-family: 'Gochi Hand', cursive;
            background: rgba(15, 25, 40, 0.7); /* Adjusted from #0f2319 */
            border: 2px solid var(--input-border);
            color: var(--text-color);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.6);
            border-radius: 8px;
            font-size: 1.2rem;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--card-border); /* Adjusted from #5fbda3 */
            box-shadow: 0 0 12px rgba(110, 162, 184, 0.7); /* Adjusted from #5fbda3 */
        }
        
        .btn-primary {
            background: linear-gradient(to bottom, var(--button-primary-start), var(--button-primary-end));
            border: 2px solid var(--card-border); /* Adjusted from #5fbda3 */
            color: #fff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);
            font-family: 'Caveat', cursive;
            font-size: 1.7rem;
            letter-spacing: 1px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            transition: all 0.2s;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary:hover {
            background: linear-gradient(to bottom, var(--card-border), var(--button-primary-start)); /* Adjusted from #5fbda3, #4a9e86 */
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
        }
        
        .btn-primary::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -60%;
            width: 20px;
            height: 200%;
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(25deg);
            transition: all 0.6s;
        }
        
        .btn-primary:hover::after {
            left: 120%;
        }
        
        .hypothesis {
            font-family: 'Gochi Hand', cursive;
        }
        
        .h0, .h1, .formula {
            background: var(--card-bg); /* Adjusted from #142d23 */
            border: 3px dashed var(--card-border); /* Adjusted from #4a9e86 */
            position: relative;
        }
        
        .h0::before, .h1::before {
            content: "";
            position: absolute;
            top: -7px;
            left: -7px;
            right: -7px;
            bottom: -7px;
            border: 1px solid rgba(110, 162, 184, 0.2); /* Adjusted from #64e6b4 */
            border-radius: 10px;
            pointer-events: none;
        }
        
        .result-value {
            font-family: 'Caveat', cursive;
            font-size: 3.8rem;
            color: var(--card-border); /* Adjusted from #5fbda3 */
            text-shadow: 0 0 10px rgba(110, 162, 184, 0.8); /* Adjusted from #5fbda3 */
            margin: 10px 0;
        }
        
        .conclusion {
            font-family: 'Gochi Hand', cursive;
            background: rgba(18, 30, 45, 0.8); /* Adjusted from #142d23 */
            border-left: 5px solid var(--card-border); /* Adjusted from #4a9e86 */
            border-radius: 8px;
            font-size: 1.2rem;
        }
        
        .highlight {
            background: var(--highlight-bg); /* Adjusted from #64e6b4 */
            border-radius: 4px;
            padding: 2px 6px;
        }
        
        .significance {
            font-family: 'Caveat', cursive;
            font-size: 1.4rem;
            padding: 4px 12px;
            border-radius: 20px;
        }
        
        .chalk-border {
            border-bottom: 3px solid var(--card-border); /* Adjusted from #4a9e86 */
            position: relative;
            padding-bottom: 12px;
        }
        
        .chalk-border::after {
            content: "";
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 120px;
            height: 3px;
            background: var(--card-border); /* Adjusted from #4a9e86 */
            border-radius: 2px;
        }
        
        .chalk-line {
            position: relative;
            padding-bottom: 8px;
        }
        
        .chalk-line::after {
            content: "";
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 80%;
            height: 2px;
            background: rgba(110, 162, 184, 0.6); /* Adjusted from #4a9e86 */
            border-radius: 1px;
        }
        
        .chalk-shadow {
            text-shadow: 0 0 4px rgba(255, 255, 255, 0.3), 0 0 8px rgba(255, 255, 255, 0.2);
        }
        
        canvas {
            background: #e1e3e1; /* Adjusted from #0a1e14 */
            border: 2px solid var(--card-border); /* Adjusted from #4a9e86 */
            border-radius: 8px;
        }
        
        .footer {
            font-family: 'Caveat', cursive;
            color: var(--card-border); /* Adjusted from #5fbda3 */
            font-size: 1.4rem;
            text-shadow: 0 0 4px rgba(110, 162, 184, 0.5); /* Adjusted from #5fbda3 */
        }
        
        .chalk-effect {
            position: relative;
            display: inline-block;
        }
        
        .chalk-effect::after {
            content: "";
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--card-border); /* Adjusted from #4a9e86 */
            border-radius: 2px;
        }
        
        .formula {
            background: rgba(15, 25, 40, 0.7); /* Adjusted from #0f2319 */
            border: 2px dashed var(--card-border); /* Adjusted from #4a9e86 */
            font-size: 1.3rem;
        }
        
        .accent-purple { /* Renamed from pink-accent */
            color: var(--accent-purple); /* Adjusted from #ff9eb5 */
            text-shadow: 0 0 6px rgba(167, 160, 222, 0.5); /* Adjusted from #ff9eb5 */
        }
        
        .accent-gold { /* Renamed from gold-accent */
            color: var(--accent-gold); /* Adjusted from #ffd166 */
            text-shadow: 0 0 6px rgba(253, 216, 93, 0.4); /* Adjusted from #ffd166 */
        }
        
        .chalk-dust {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background: radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.05) 0%, transparent 80%),
                        radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.05) 0%, transparent 80%);
            z-index: -1;
            border-radius: 8px;
        }
        
        .chalk-underline {
            display: inline-block;
            position: relative;
        }
        
        .chalk-underline::after {
            content: "";
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--card-border); /* Adjusted from #4a9e86 */
        }

        /* Specific styles for error and success messages */
        .bg-red-900 { background-color: var(--error-color); }
        .border-red-700 { border-color: var(--error-color); }
        .text-red-200 { color: #ffebeb; } /* Light red for error text */

        .bg-green-900 { background-color: var(--success-color); }
        .border-green-700 { border-color: var(--success-color); }
        .text-green-200 { color: #ebffee; } /* Light green for success text */

        /* Responsive image in header */
        .header-image {
            display: inline-block;
            vertical-align: middle;
            margin-right: 15px; /* Space between image and title */
            width: 60px; /* Adjust size as needed */
            height: 60px;
            animation: bounce 2s infinite ease-in-out;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* SVG styles for the interesting image */
        .math-doodle {
            stroke: var(--accent-gold); /* Gold color for the lines */
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
    </style>
</head>
<body class="p-4">
    <div class="chalkboard max-w-6xl mx-auto rounded-lg p-6 md:p-8 my-8">
        <div class="chalk-dust"></div>
        
        <header class="text-center mb-10 py-6 relative">
            <div class="absolute top-0 left-0 right-0 h-3 bg-gradient-to-r from-transparent via-var(--card-border) to-transparent"></div>
            <h1 class="text-5xl md:text-6xl font-bold mb-2 flex items-center justify-center">
                <!-- Interesting Image SVG -->
                <svg class="header-image" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="40" class="math-doodle" stroke-dasharray="251.32" stroke-dashoffset="0">
                        <animate attributeName="stroke-dashoffset" from="0" to="251.32" dur="3s" repeatCount="indefinite" />
                    </circle>
                    <path d="M 30 70 L 70 30" class="math-doodle" />
                    <path d="M 30 30 L 70 70" class="math-doodle" />
                    <text x="50" y="55" font-family="Caveat" font-size="25" fill="var(--accent-purple)" text-anchor="middle" dominant-baseline="middle">$\Sigma$</text>
                </svg>
                <span class="chalk-underline">Kalkulator Uji Statistik</span>
            </h1>
            <p class="text-2xl accent-gold">Analisis hubungan penempatan si A dan si B dalam satu section</p>
            <div class="absolute bottom-0 left-0 right-0 h-3 bg-gradient-to-r from-transparent via-var(--card-border) to-transparent"></div>
        </header>

        <div class="main-content grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Input Section -->
            <div class="card p-6 relative">
                <div class="chalk-dust"></div>
                <h2 class="text-3xl font-bold mb-6 chalk-border pb-3 accent-purple">
                    <i class="fas fa-sliders-h mr-3"></i>Parameter Uji
                </h2>

                <div id="errorMessage" class="hidden bg-red-900 border-2 border-red-700 text-red-200 px-4 py-3 rounded-lg relative mb-4" role="alert">
                    <strong class="font-bold">Kesalahan!</strong>
                    <span class="block sm:inline" id="errorText"></span>
                </div>

                <div class="input-group mb-5">
                    <label for="sectionCount" class="block text-xl mb-2 chalk-line">Jumlah Section Tersedia (N)</label>
                    <input type="number" id="sectionCount" min="2" max="20" value="5" class="w-full p-3 rounded-lg text-xl">
                    <small class="text-blue-200">Probabilitas acak ($p_0$) akan dihitung otomatis sebagai $1/N$</small>
                </div>

                <div class="input-group mb-5">
                    <label for="totalAssignments" class="block text-xl mb-2 chalk-line">Jumlah Penugasan Section (n)</label>
                    <input type="number" id="totalAssignments" min="1" max="100" value="10" class="w-full p-3 rounded-lg text-xl">
                </div>

                <div class="input-group mb-5">
                    <label for="sameSectionCount" class="block text-xl mb-2 chalk-line">Jumlah Kali A dan B Satu Section (k)</label>
                    <input type="number" id="sameSectionCount" min="0" max="100" value="7" class="w-full p-3 rounded-lg text-xl">
                </div>

                <div class="input-group mb-6">
                    <label for="alpha" class="block text-xl mb-2 chalk-line">Tingkat Signifikansi ($\alpha$)</label>
                    <select id="alpha" class="w-full p-3 rounded-lg text-xl">
                        <option value="0.01">0.01 (1%)</option>
                        <option value="0.05" selected>0.05 (5%)</option>
                        <option value="0.10">0.10 (10%)</option>
                    </select>
                </div>

                <button id="calculateBtn" class="btn-primary font-bold py-3 px-6 rounded-lg w-full text-2xl">
                    <i class="fas fa-calculator mr-2"></i> Hitung Statistik
                </button>
            </div>

            <!-- Hypothesis Section -->
            <div class="card p-6 relative">
                <div class="chalk-dust"></div>
                <h2 class="text-3xl font-bold mb-6 chalk-border pb-3 accent-purple">
                    <i class="fas fa-question-circle mr-3"></i>Hipotesis Statistik
                </h2>

                <div class="hypothesis grid grid-cols-1 gap-4">
                    <div class="h0 p-5 rounded-lg">
                        <h4 class="text-red-300 text-2xl font-bold mb-2 flex items-center gap-2">
                            <i class="fas fa-times-circle"></i> Hipotesis Nol ($H_0$)
                        </h4>
                        <p class="text-xl">Tidak ada hubungan antara si A dan si B satu section. Penempatan mereka dalam satu section adalah murni kebetulan.</p>
                        <div class="formula font-mono p-3 rounded-md my-3 overflow-x-auto text-xl">
                            $P(\text{A dan B satu section}) = p_0 = 1/N$
                        </div>
                    </div>

                    <div class="h1 p-5 rounded-lg">
                        <h4 class="text-green-300 text-2xl font-bold mb-2 flex items-center gap-2">
                            <i class="fas fa-check-circle"></i> Hipotesis Alternatif ($H_1$)
                        </h4>
                        <p class="text-xl">Ada hubungan antara si A dan si B satu section. Penempatan mereka dalam satu section bukan kebetulan.</p>
                        <div class="formula font-mono p-3 rounded-md my-3 overflow-x-auto text-xl">
                            $P(\text{A dan B satu section}) > p_0$
                        </div>
                    </div>
                </div>

                <div class="bg-blue-900 bg-opacity-30 p-6 rounded-xl mt-6 border-2 border-dashed border-var(--card-border)">
                    <h3 class="text-2xl font-bold mb-4 accent-purple">Interpretasi P-value</h3>
                    <p class="text-xl mb-3">P-value adalah probabilitas untuk mendapatkan hasil pengamatan (atau hasil yang lebih ekstrem) jika hipotesis nol ($H_0$) adalah benar.</p>
                    <ul class="list-disc pl-5 text-xl">
                        <li class="mb-2"><span class="highlight">P-value rendah</span> ($< \alpha$): Menolak $H_0$, menunjukkan bukti kuat bahwa penempatan tidak acak.</li>
                        <li><span class="highlight">P-value tinggi</span> ($\ge \alpha$): Tidak cukup bukti untuk menolak $H_0$, penempatan mungkin acak.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="mt-8">
            <h2 class="text-4xl font-bold mb-6 chalk-border pb-3 text-center accent-purple">
                <i class="fas fa-chart-bar mr-3"></i>Hasil Perhitungan Statistik
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-6 text-center relative">
                    <div class="chalk-dust"></div>
                    <h3 class="text-3xl font-bold mb-2">Uji Binomial</h3>
                    <p class="text-xl mb-3">Probabilitas kumulatif: $P(X \ge k | n, p_0)$</p>
                    <div class="result-value" id="binomialResult">-</div>
                    <p class="text-xl">Probabilitas mendapatkan hasil observasi atau lebih ekstrem jika $H_0$ benar</p>
                    <div id="binomialConclusion" class="conclusion p-4 rounded-lg mt-4 text-xl">Masukkan parameter dan klik "Hitung Statistik"</div>
                    <div class="chart-container mt-4">
                        <canvas id="binomialChart" height="150"></canvas>
                    </div>
                </div>

                <div class="card p-6 text-center relative">
                    <div class="chalk-dust"></div>
                    <h3 class="text-3xl font-bold mb-2">Uji Chi-Square</h3>
                    <p class="text-xl mb-3">Statistik Chi-Square: $\chi^2 = \sum\frac{(O-E)^2}{E}$</p>
                    <div class="result-value" id="chiSquareResult">-</div>
                    <p class="text-xl">Nilai chi-square dengan derajat kebebasan = 1</p>
                    <div id="chiSquareConclusion" class="conclusion p-4 rounded-lg mt-4 text-xl">Masukkan parameter dan klik "Hitung Statistik"</div>
                    <div class="chart-container mt-4">
                        <canvas id="chiSquareChart" height="150"></canvas>
                    </div>
                </div>
            </div>

            <div class="card mt-8 p-6 relative">
                <div class="chalk-dust"></div>
                <h3 class="text-3xl font-bold mb-4 accent-purple">Kesimpulan Analisis</h3>
                <div id="finalConclusion" class="text-xl">
                    Silakan masukkan parameter di atas dan klik tombol "Hitung Statistik" untuk melakukan analisis.
                </div>
                <button id="explainAnalysisBtn" class="hidden btn-primary font-bold py-3 px-6 rounded-lg w-full mt-6 text-2xl">
                    <i class="fas fa-magic mr-2"></i>✨ Jelaskan Hasil Analisis
                </button>
            </div>

            <!-- LLM Explanation Section -->
            <div id="llmExplanationCard" class="hidden card p-6 mt-6 relative">
                <div class="chalk-dust"></div>
                <h2 class="text-3xl font-bold mb-5 chalk-border pb-3 accent-purple">
                    <i class="fas fa-heart mr-3"></i>Kisah Hubungan A & B
                </h2>
                <div id="llmExplanationContent" class="prose max-w-none text-xl">
                    <div class="flex flex-col justify-center items-center py-10">
                        <i class="fas fa-spinner fa-spin text-blue-400 text-4xl mb-4"></i>
                        <p class="text-blue-300 text-2xl">Mengungkap kisah hubungan A & B...</p>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center py-6 mt-8 border-t border-var(--card-border) border-opacity-30 footer">
            <p>Kalkulator Uji Statistik &copy; 2025 | Ditenagai oleh Cinta </p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            // Initial canvas sizing and drawing
            resizeCanvas();
            // Recalculate and redraw charts if input fields have values on load
            // (e.g., if user refreshed page with filled inputs)
            if (document.getElementById('sectionCount').value && document.getElementById('totalAssignments').value && document.getElementById('sameSectionCount').value) {
                calculateStatistics();
            }
        });
        window.addEventListener('resize', resizeCanvas);

        document.getElementById('calculateBtn').addEventListener('click', calculateStatistics);
        document.getElementById('explainAnalysisBtn').addEventListener('click', generateExplanation);

        // Global variables to store the last calculated results for LLM explanation
        let lastBinomialPValue = 0;
        let lastChiSquareResult = {};
        let lastAlpha = 0;
        let lastFinalConclusionText = '';
        let lastSectionCount = 0;
        let lastTotalAssignments = 0;
        let lastSameSectionCount = 0;
        let lastP0 = 0;

        /**
         * Sets the canvas width to match its parent container and redraws charts.
         */
        function resizeCanvas() {
            const chartContainers = document.querySelectorAll('.chart-container');
            chartContainers.forEach(container => {
                const canvas = container.querySelector('canvas');
                if (canvas) {
                    canvas.width = container.clientWidth;
                    // Ensure a consistent height for the canvas
                    canvas.height = 150; 
                    
                    // Redraw chart if data exists
                    const canvasId = canvas.id;
                    if (canvasId === 'binomialChart' && lastBinomialPValue !== 0) {
                        drawNormalDistributionChart(canvasId, lastBinomialPValue, 'right');
                    } else if (canvasId === 'chiSquareChart' && lastChiSquareResult.pValue !== undefined) {
                        drawNormalDistributionChart(canvasId, lastChiSquareResult.pValue, 'two-tailed');
                    }
                }
            });
        }


        /**
         * Displays an error message on the page.
         * @param {string} message - The error message to display.
         */
        function showErrorMessage(message) {
            const errorMessageDiv = document.getElementById('errorMessage');
            document.getElementById('errorText').textContent = message;
            errorMessageDiv.classList.remove('hidden'); // Show the error div
        }

        /**
         * Hides the error message from the page.
         */
        function hideErrorMessage() {
            const errorMessageDiv = document.getElementById('errorMessage');
            errorMessageDiv.classList.add('hidden'); // Hide the error div
        }

        /**
         * Main function to calculate and display statistical results based on user input.
         */
        function calculateStatistics() {
            hideErrorMessage(); // Clear any previous error messages

            // Get input values from the DOM
            const sectionCount = parseInt(document.getElementById('sectionCount').value);
            const totalAssignments = parseInt(document.getElementById('totalAssignments').value);
            const sameSectionCount = parseInt(document.getElementById('sameSectionCount').value);
            const alpha = parseFloat(document.getElementById('alpha').value);

            // Validate input values
            if (isNaN(sectionCount) || sectionCount < 2) {
                showErrorMessage('Jumlah Section Tersedia harus angka dan minimal 2.');
                return;
            }
            if (isNaN(totalAssignments) || totalAssignments < 1) {
                showErrorMessage('Jumlah Penugasan Section harus angka dan minimal 1.');
                return;
            }
            if (isNaN(sameSectionCount) || sameSectionCount < 0 || sameSectionCount > totalAssignments) {
                showErrorMessage('Jumlah Kali A dan B Satu Section harus angka dan tidak boleh melebihi Jumlah Penugasan.');
                return;
            }

            // Calculate probability under the Null Hypothesis (H0)
            const p0 = 1 / sectionCount;

            // Perform the Binomial Test
            const binomialPValue = binomialTest(totalAssignments, sameSectionCount, p0);

            // Perform the Chi-Square Test
            const chiSquareResult = chiSquareTest(totalAssignments, sameSectionCount, p0);

            // Store results in global variables for LLM
            lastBinomialPValue = binomialPValue;
            lastChiSquareResult = chiSquareResult;
            lastAlpha = alpha;
            lastSectionCount = sectionCount;
            lastTotalAssignments = totalAssignments;
            lastSameSectionCount = sameSectionCount;
            lastP0 = p0;

            // Display all results and conclusions on the UI
            displayResults(binomialPValue, chiSquareResult, alpha);

            // Draw charts
            // For charting, we simplify to normal distribution for visual representation.
            // Binomial test is often approximated by normal for large n.
            // Chi-square with 1df is related to Z-squared.
            drawNormalDistributionChart('binomialChart', binomialPValue, 'right'); // Binomial is one-tailed (right)
            drawNormalDistributionChart('chiSquareChart', chiSquareResult.pValue, 'two-tailed'); // Chi-square is two-tailed in Z-score equivalent

            // Show the LLM explanation button
            document.getElementById('explainAnalysisBtn').classList.remove('hidden');
            // Hide previous LLM explanation
            document.getElementById('llmExplanationCard').classList.add('hidden');
        }

        /**
         * Calculates the cumulative probability P(X >= k) for a binomial distribution.
         * This is used as the p-value for a one-tailed (upper tail) binomial test.
         * @param {number} n - Number of trials (total assignments).
         * @param {number} k - Number of successes (times A and B are in the same section).
         * @param {number} p0 - Probability of success on a single trial under the null hypothesis (1/sectionCount).
         * @returns {number} The cumulative probability P(X >= k).
         */
        function binomialTest(n, k, p0) {
            let pValue = 0;
            // Sum probabilities for X = k, k+1, ..., n
            for (let i = k; i <= n; i++) {
                pValue += binomialProbability(n, i, p0);
            }
            return pValue;
        }

        /**
         * Calculates the probability mass function for a binomial distribution: P(X = k).
         * P(X = k) = C(n, k) * p^k * (1-p)^(n-k)
         * @param {number} n - Number of trials.
         * @param {number} k - Number of successes.
         * @param {number} p - Probability of success on a single trial.
         * @returns {number} The probability of exactly k successes.
         */
        function binomialProbability(n, k, p) {
            // Calculate binomial coefficient C(n, k) = n! / (k! * (n-k)!)
            // This loop calculates C(n, k) efficiently
            let coeff = 1;
            for (let i = 0; i < k; i++) {
                coeff = coeff * (n - i) / (i + 1);
            }

            // Calculate the full binomial probability
            return coeff * Math.pow(p, k) * Math.pow(1 - p, n - k);
        }

        /**
         * Probability Density Function (PDF) for a standard normal distribution.
         * @param {number} x - The value for which to calculate the PDF.
         * @returns {number} The probability density at x.
         */
        function normalPDF(x) {
            return (1 / Math.sqrt(2 * Math.PI)) * Math.exp(-0.5 * x * x);
        }

        /**
         * Performs a Chi-Square goodness-of-fit test for two categories (same section vs. different section).
         * It calculates the chi-square statistic and its corresponding p-value (for df=1).
         * @param {number} n - Total number of assignments.
         * @param {number} observedSame - Observed count of A and B in the same section.
         * @param {number} p0 - Expected probability of A and B in the same section under H0.
         * @returns {object} An object containing the chi-square statistic, its p-value, and observed/expected counts.
         */
        function chiSquareTest(n, observedSame, p0) {
            // Calculate expected frequencies under H0
            const expectedSame = n * p0;
            const expectedDifferent = n * (1 - p0);

            // Calculate observed frequency for "different section"
            const observedDifferent = n - observedSame;

            // Define a small epsilon to prevent division by zero in case expected frequencies are 0
            const epsilon = 1e-9;

            // Chi-square statistic formula: Σ[(Observed - Expected)² / Expected]
            const chiSquare =
                (Math.pow(observedSame - expectedSame, 2) / (expectedSame + epsilon)) +
                (Math.pow(observedDifferent - expectedDifferent, 2) / (expectedDifferent + epsilon));

            // For a chi-square distribution with 1 degree of freedom, its p-value
            // can be derived from the standard normal distribution's Z-score (where chi-square = Z^2).
            // We use 2 * P(Z > |z|) for the two-tailed normal equivalent.
            const z = Math.sqrt(chiSquare);
            const pValue = 2 * (1 - normalCDF(Math.abs(z)));

            return {
                chiSquare: chiSquare,
                pValue: pValue,
                observedSame: observedSame,
                observedDifferent: observedDifferent,
                expectedSame: expectedSame,
                expectedDifferent: expectedDifferent
            };
        }

        /**
         * Approximation of the cumulative distribution function (CDF) for a standard normal distribution.
         * This function returns P(Z <= x). Uses the Abramowitz and Stegun approximation.
         * @param {number} x - The value for which to calculate the CDF.
         * @returns {number} The cumulative probability P(Z <= x).
         */
        function normalCDF(x) {
            // Constants for the approximation
            const a1 = 0.2316419;
            const a2 = 0.319381530;
            const a3 = -0.356563782;
            const a4 = 1.781477937;
            const a5 = -1.821255978;
            const a6 = 1.330274429;

            const sign = x < 0 ? -1 : 1;
            const absX = Math.abs(x);

            const t = 1 / (1 + a1 * absX);

            // This part approximates 1 - P(Z <= absX) = P(Z > absX)
            let probGreater = 0.3989422804014327 * Math.exp(-0.5 * absX * absX) *
                (a2 * t + a3 * Math.pow(t, 2) + a4 * Math.pow(t, 3) + a5 * Math.pow(t, 4) + a6 * Math.pow(t, 5));

            if (sign === -1) {
                // If x is negative, CDF(x) = 1 - CDF(-x) = 1 - P(Z <= absX)
                // So CDF(x) = probGreater in this context (due to the formulation of probGreater)
                return probGreater;
            } else {
                // If x is positive, CDF(x) = 1 - P(Z > x)
                return 1 - probGreater;
            }
        }

        /**
         * Calculates the Z-score for a given p-value.
         * This is the inverse of the normalCDF function, approximated.
         * @param {number} p - The p-value.
         * @returns {number} The Z-score corresponding to the p-value.
         */
        function normalInverseCDF(p) {
            if (p < 0.00000000001) return -6; // Very low p-value
            if (p > 0.99999999999) return 6;  // Very high p-value

            // Inverse CDF approximation (using a polynomial approximation for error function inverse)
            // This is a common approximation for standard normal inverse CDF
            const q = p > 0.5 ? 1 - p : p;
            const t = Math.sqrt(-2 * Math.log(q));
            const c0 = 2.515517;
            const c1 = 0.802853;
            const c2 = 0.010328;
            const d1 = 1.432788;
            const d2 = 0.189269;
            const d3 = 0.001308;
            let z = t - ((c0 + c1 * t + c2 * t * t) / (1 + d1 * t + d2 * t * t + d3 * t * t * t));
            if (p < 0.5) {
                z = -z;
            }
            return z;
        }


        /**
         * Displays the calculated statistical results and conclusions on the web page.
         * Dynamically updates the UI with p-values, chi-square statistic, and interpretations.
         * @param {number} binomialPValue - P-value obtained from the binomial test.
         * @param {object} chiSquareResult - Object containing chi-square statistic and p-value.
         * @param {number} alpha - The chosen significance level ($\alpha$).
         */
        function displayResults(binomialPValue, chiSquareResult, alpha) {
            // Update Binomial Test results
            document.getElementById('binomialResult').textContent = binomialPValue.toFixed(6);
            const binomialConclusion = document.getElementById('binomialConclusion');
            // Reset styles before applying new ones
            binomialConclusion.classList.remove('bg-red-900', 'border-red-700', 'text-red-200', 'bg-green-900', 'border-green-700', 'text-green-200');

            if (binomialPValue < alpha) {
                binomialConclusion.innerHTML = `<strong class="block text-2xl mb-1">Menolak H₀ ($p < \alpha$)</strong>
                    <p class="text-xl">Ada bukti kuat bahwa penempatan A dan B dalam satu section tidak acak.</p>
                    <span class="significance bg-green-900 text-green-200 px-3 py-1 rounded-full mt-2">Signifikan secara statistik</span>`;
                binomialConclusion.classList.add('bg-green-900', 'border-green-700', 'text-green-200');
            } else {
                binomialConclusion.innerHTML = `<strong class="block text-2xl mb-1">Gagal menolak H₀ ($p \ge \alpha$)</strong>
                    <p class="text-xl">Tidak cukup bukti bahwa penempatan A dan B dalam satu section tidak acak.</p>
                    <span class="significance bg-red-900 text-red-200 px-3 py-1 rounded-full mt-2">Tidak signifikan</span>`;
                binomialConclusion.classList.add('bg-red-900', 'border-red-700', 'text-red-200');
            }

            // Update Chi-Square Test results
            document.getElementById('chiSquareResult').textContent = chiSquareResult.chiSquare.toFixed(4);
            const chiSquareConclusion = document.getElementById('chiSquareConclusion');
            // Reset styles before applying new ones
            chiSquareConclusion.classList.remove('bg-red-900', 'border-red-700', 'text-red-200', 'bg-green-900', 'border-green-700', 'text-green-200');

            if (chiSquareResult.pValue < alpha) {
                chiSquareConclusion.innerHTML = `<strong class="block text-2xl mb-1">Menolak H₀ ($p = ${chiSquareResult.pValue.toFixed(6)}$)</strong>
                    <p class="text-xl">Distribusi observasi berbeda signifikan dari ekspektasi.</p>
                    <span class="significance bg-green-900 text-green-200 px-3 py-1 rounded-full mt-2">Signifikan secara statistik</span>`;
                chiSquareConclusion.classList.add('bg-green-900', 'border-green-700', 'text-green-200');
            } else {
                chiSquareConclusion.innerHTML = `<strong class="block text-2xl mb-1">Gagal menolak H₀ ($p = ${chiSquareResult.pValue.toFixed(6)}$)</strong>
                    <p class="text-xl">Tidak cukup bukti bahwa distribusi observasi berbeda signifikan dari ekspektasi.</p>
                    <span class="significance bg-red-900 text-red-200 px-3 py-1 rounded-full mt-2">Tidak signifikan</span>`;
                chiSquareConclusion.classList.add('bg-red-900', 'border-red-700', 'text-red-200');
            }

            // Determine final conclusion based on both tests
            const finalConclusionElement = document.getElementById('finalConclusion');
            if (binomialPValue < alpha && chiSquareResult.pValue < alpha) {
                lastFinalConclusionText = `Berdasarkan Uji Binomial (p-value = ${binomialPValue.toFixed(6)}) dan Uji Chi-Square (p-value = ${chiSquareResult.pValue.toFixed(6)}), yang keduanya < \alpha (${alpha}), kita memiliki <span class="highlight font-bold">bukti statistik yang kuat untuk menolak Hipotesis Nol.</span> Ini menunjukkan bahwa penempatan A dan B dalam satu section <span class="highlight font-bold">bukanlah kebetulan semata</span> dan kemungkinan ada faktor lain yang mempengaruhinya.`;
            } else if (binomialPValue < alpha && chiSquareResult.pValue >= alpha) {
                lastFinalConclusionText = `Uji Binomial (p-value = ${binomialPValue.toFixed(6)}) menunjukkan hasil signifikan (< \alpha ${alpha}), namun Uji Chi-Square (p-value = ${chiSquareResult.pValue.toFixed(6)}) tidak signifikan. Hal ini mungkin mengindikasikan adanya efek, tetapi dengan dukungan yang tidak konsisten dari kedua metode. Interpretasi lebih lanjut diperlukan.`;
            } else if (binomialPValue >= alpha && chiSquareResult.pValue < alpha) {
                lastFinalConclusionText = `Uji Chi-Square (p-value = ${chiSquareResult.pValue.toFixed(6)}) menunjukkan hasil signifikan (< \alpha ${alpha}), namun Uji Binomial (p-value = ${binomialPValue.toFixed(6)}) tidak signifikan. Ini mungkin terjadi karena perbedaan asumsi antara kedua tes. Interpretasi lebih lanjut diperlukan.`;
            } else {
                lastFinalConclusionText = `Berdasarkan Uji Binomial (p-value = ${binomialPValue.toFixed(6)}) dan Uji Chi-Square (p-value = ${chiSquareResult.pValue.toFixed(6)}), yang keduanya $\ge \alpha$ (${alpha}), kita <span class="highlight font-bold">gagal menolak Hipotesis Nol.</span> Ini berarti tidak ada cukup bukti statistik untuk menyatakan bahwa penempatan A dan B dalam satu section bukanlah kebetulan. Hasil yang diamati mungkin <span class="highlight font-bold">disebabkan oleh peluang acak.</span>`;
            }
            finalConclusionElement.innerHTML = lastFinalConclusionText;
        }

        /**
         * Draws a normal distribution curve on a given canvas, highlighting the p-value area.
         * @param {string} canvasId - The ID of the canvas element.
         * @param {number} pValue - The calculated p-value.
         * @param {string} tailType - 'left', 'right', or 'two-tailed' for shading.
         */
        function drawNormalDistributionChart(canvasId, pValue, tailType) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return; // Exit if canvas not found
            const ctx = canvas.getContext('2d');

            // Clear previous drawings
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Set drawing properties
            ctx.strokeStyle = 'var(--chart-curve-color)'; 
            ctx.lineWidth = 2;
            ctx.font = "12px 'Gochi Hand', cursive";
            ctx.fillStyle = 'var(--text-color)'; // Default text color

            const width = canvas.width;
            const height = canvas.height;
            
            // Add padding to ensure chart elements are not cut off
            const padding = 20; // Adjust padding as needed
            const drawAreaWidth = width - (2 * padding);
            const drawAreaHeight = height - (2 * padding);
            const drawAreaX = padding;
            const drawAreaY = padding;

            // X-axis scale (e.g., -3.5 to 3.5 standard deviations for Z-scores)
            const xMin = -3.5;
            const xMax = 3.5;
            const xScale = drawAreaWidth / (xMax - xMin);

            // Y-axis scale (density function, max at 0 is normalPDF(0) = ~0.3989)
            const yMaxDensity = normalPDF(0); 
            const yScale = drawAreaHeight / yMaxDensity; 

            // Draw X-axis (mean at 0)
            const centerY = drawAreaY + drawAreaHeight; // Position X-axis at the bottom of the drawing area
            ctx.beginPath();
            ctx.strokeStyle = 'var(--chart-axis-color)'; /* Changed to specific axis color */
            ctx.moveTo(drawAreaX, centerY);
            ctx.lineTo(drawAreaX + drawAreaWidth, centerY);
            ctx.stroke();
            ctx.strokeStyle = 'var(--chart-curve-color)'; /* Reset to curve color for drawing curve */


            // Draw normal distribution curve
            ctx.beginPath();
            for (let x = xMin; x <= xMax; x += 0.01) {
                const screenX = drawAreaX + (x - xMin) * xScale;
                const y = normalPDF(x); // Use PDF for curve height
                const screenY = centerY - (y * yScale);
                if (x === xMin) {
                    ctx.moveTo(screenX, screenY);
                } else {
                    ctx.lineTo(screenX, screenY);
                }
            }
            ctx.stroke();

            // Calculate Z-score for p-value (observed Z)
            let observedZ = normalInverseCDF(1 - pValue); 

            // Shading the p-value area - USING NEW CHART SHADING COLOR FOR HIGHER CONTRAST
            ctx.fillStyle = 'var(--chart-shading-color)'; 
            ctx.beginPath();
            
            if (tailType === 'right') {
                ctx.moveTo(drawAreaX + (observedZ - xMin) * xScale, centerY);
                for (let x = observedZ; x <= xMax; x += 0.01) {
                    const screenX = drawAreaX + (x - xMin) * xScale;
                    const y = normalPDF(x);
                    const screenY = centerY - (y * yScale);
                    ctx.lineTo(screenX, screenY);
                }
                ctx.lineTo(drawAreaX + (xMax - xMin) * xScale, centerY); // Back to x-axis
            } else if (tailType === 'left') {
                ctx.moveTo(drawAreaX + (observedZ - xMin) * xScale, centerY);
                for (let x = observedZ; x >= xMin; x -= 0.01) {
                    const screenX = drawAreaX + (x - xMin) * xScale;
                    const y = normalPDF(x);
                    const screenY = centerY - (y * yScale);
                    ctx.lineTo(screenX, screenY);
                }
                ctx.lineTo(drawAreaX + (xMin - xMin) * xScale, centerY); // Back to x-axis
            } else if (tailType === 'two-tailed') {
                // For two-tailed, shade both tails based on |observedZ|
                const absObservedZ = Math.abs(observedZ);
                const zLower = -absObservedZ;
                const zUpper = absObservedZ;

                // Right tail
                ctx.moveTo(drawAreaX + (zUpper - xMin) * xScale, centerY);
                for (let x = zUpper; x <= xMax; x += 0.01) {
                    const screenX = drawAreaX + (x - xMin) * xScale;
                    const y = normalPDF(x);
                    const screenY = centerY - (y * yScale);
                    ctx.lineTo(screenX, screenY);
                }
                ctx.lineTo(drawAreaX + (xMax - xMin) * xScale, centerY);
                ctx.closePath();
                ctx.fill();

                // Left tail
                ctx.beginPath();
                ctx.moveTo(drawAreaX + (zLower - xMin) * xScale, centerY);
                for (let x = zLower; x >= xMin; x -= 0.01) {
                    const screenX = drawAreaX + (x - xMin) * xScale;
                    const y = normalPDF(x);
                    const screenY = centerY - (y * yScale);
                    ctx.lineTo(screenX, screenY);
                }
                ctx.lineTo(drawAreaX + (xMin - xMin) * xScale, centerY);
            }
            ctx.closePath();
            ctx.fill();


            // Draw vertical line for Observed Z-score
            ctx.strokeStyle = 'var(--accent-purple)'; // Purple for observed Z - KEPT THIS COLOR
            ctx.beginPath();
            const observedZPDF = normalPDF(observedZ);
            ctx.moveTo(drawAreaX + (observedZ - xMin) * xScale, centerY);
            ctx.lineTo(drawAreaX + (observedZ - xMin) * xScale, centerY - (observedZPDF * yScale)); // Draw up to the curve
            ctx.stroke();

            // Label the Observed Z-score
            const labelXPos = drawAreaX + (observedZ - xMin) * xScale;
            const labelYPos = centerY - (observedZPDF * yScale);
            
            // Set label fill style for observed Z-score labels
            ctx.fillStyle = 'var(--chart-observed-z-label)'; 

            // Adjust label position to ensure visibility and avoid overlap with curve
            const textYOffset = 15; // Vertical offset for text from the line
            const textXOffset = 5; // Horizontal offset

            if (labelYPos - textYOffset < drawAreaY) { 
                ctx.fillText(`Z=${observedZ.toFixed(2)}`, labelXPos + textXOffset, labelYPos + textYOffset);
                ctx.fillText(`p=${pValue.toFixed(3)}`, labelXPos + textXOffset, labelYPos + textYOffset + 15);
            } else { 
                ctx.fillText(`Z=${observedZ.toFixed(2)}`, labelXPos + textXOffset, labelYPos - textYOffset);
                ctx.fillText(`p=${pValue.toFixed(3)}`, labelXPos + textXOffset, labelYPos - textYOffset - 15);
            }


            // Draw critical Z-score line for alpha (if applicable)
            ctx.strokeStyle = 'var(--accent-gold)'; // Gold for critical Z - KEPT THIS COLOR
            ctx.beginPath();
            const alpha = parseFloat(document.getElementById('alpha').value);
            
            // Set label fill style for critical Z-score labels
            ctx.fillStyle = 'var(--chart-critical-z-label)';

            if (tailType === 'right') {
                let zCritical = normalInverseCDF(1 - alpha); // One-tailed right
                const criticalXPos = drawAreaX + (zCritical - xMin) * xScale;
                const criticalYPos = centerY - (normalPDF(zCritical) * yScale);
                ctx.moveTo(criticalXPos, centerY);
                ctx.lineTo(criticalXPos, criticalYPos);
                ctx.fillText(`Z_crit=${zCritical.toFixed(2)}`, criticalXPos + textXOffset, criticalYPos - textYOffset);
            } else if (tailType === 'two-tailed') {
                const absZCritical = normalInverseCDF(1 - alpha / 2); 
                
                // Left critical
                const leftCriticalXPos = drawAreaX + (-absZCritical - xMin) * xScale;
                const leftCriticalYPos = centerY - (normalPDF(-absZCritical) * yScale);
                ctx.moveTo(leftCriticalXPos, centerY);
                ctx.lineTo(leftCriticalXPos, leftCriticalYPos);
                ctx.stroke(); 
                ctx.fillText(`Z_crit=${(-absZCritical).toFixed(2)}`, leftCriticalXPos - 80, leftCriticalYPos - textYOffset);

                // Right critical
                ctx.beginPath();
                const rightCriticalXPos = drawAreaX + (absZCritical - xMin) * xScale;
                const rightCriticalYPos = centerY - (normalPDF(absZCritical) * yScale);
                ctx.moveTo(rightCriticalXPos, centerY);
                ctx.lineTo(rightCriticalXPos, rightCriticalYPos);
                ctx.fillText(`Z_crit=${absZCritical.toFixed(2)}`, rightCriticalXPos + textXOffset, rightCriticalYPos - textYOffset);
            }
            ctx.stroke();
        }

        /**
         * Generates an explanation for the statistical analysis results using the Gemini API.
         * Displays a loading spinner and then the generated text.
         */
        async function generateExplanation() {
            const llmExplanationCard = document.getElementById('llmExplanationCard');
            const llmExplanationContent = document.getElementById('llmExplanationContent');
            
            // Show loading state
            llmExplanationCard.classList.remove('hidden');
            llmExplanationContent.innerHTML = `
                <div class="flex flex-col justify-center items-center py-10">
                    <i class="fas fa-spinner fa-spin text-blue-400 text-4xl mb-4"></i>
                    <p class="text-blue-300 text-2xl">Mengungkap kisah hubungan A & B...</p>
                </div>
            `;

            // Construct the prompt for the LLM
            const prompt = `Bayangkan ini adalah kisah cinta antara A dan B yang ditempatkan di berbagai section.

Parameter hubungan mereka:
- Total kesempatan bersama (penugasan): ${lastTotalAssignments}
- Jumlah kali mereka 'berjodoh' di section yang sama: ${lastSameSectionCount}
- Jika semua acak, peluang 'berjodoh' per kesempatan: ${lastP0.toFixed(4)} (dari ${lastSectionCount} section)
- Batas 'rasa curiga' (tingkat signifikansi alpha): ${lastAlpha}

Hasil uji Binomial (melihat apakah mereka 'berjodoh' lebih sering dari kebetulan):
- P-value (probabilitas kebetulan mereka 'berjodoh' sebanyak ini atau lebih): ${lastBinomialPValue.toFixed(6)}

Hasil uji Chi-Square (melihat apakah pola 'berjodoh' atau tidak 'berjodoh' ini aneh jika hanya kebetulan):
- P-value (probabilitas pola ini muncul jika hanya kebetulan): ${lastChiSquareResult.pValue.toFixed(6)}

Kesimpulan awal: ${lastFinalConclusionText.replace(/<[^>]*>?/gm, '')}

Tolong ceritakan kisah singkat tentang A dan B berdasarkan data ini. Apakah alam semesta berkonspirasi untuk menyatukan mereka (hubungan signifikan), atau ini hanya kebetulan semata (tidak signifikan)? Gunakan analogi yang romantis dan mudah dicerna, fokus pada apakah 'takdir' (hubungan non-acak) atau 'kebetulan' (hubungan acak) yang memainkan peran. Buat ceritanya sangat ringkas, puitis, dan menyentuh, seolah-olah Anda adalah pencerita cinta. Jangan gunakan angka atau istilah statistik secara langsung dalam cerita, cukup interpretasinya. Mulailah dengan narasi, jangan langsung ke poin-poin.`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = "" // API key is provided by Canvas runtime

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // Check if response status is 403 specifically
                    if (response.status === 403) {
                        llmExplanationContent.innerHTML = `<p class="text-red-300">Terjadi kesalahan: Akses ke Gemini API ditolak (Status 403 Forbidden). Mohon pastikan API Key Anda valid dan memiliki izin yang sesuai.</p>`;
                        console.error('API call failed with status 403: Check API Key permissions or validity.');
                    } else {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                } else {
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        llmExplanationContent.innerHTML = `<p class="whitespace-pre-wrap">${text}</p>`; // Use pre-wrap to respect LLM formatting
                    } else {
                        llmExplanationContent.innerHTML = `<p class="text-red-300">Maaf, saya tidak dapat menghasilkan penjelasan. Struktur respons dari API tidak terduga.</p>`;
                        console.error('Unexpected API response structure:', result);
                    }
                }
            } catch (error) {
                if (error.message.includes('403')) {
                     // This catch block might still be hit for 403 if thrown before specific check
                     llmExplanationContent.innerHTML = `<p class="text-red-300">Terjadi kesalahan: Akses ke Gemini API ditolak. Mohon pastikan API Key Anda valid dan memiliki izin yang sesuai.</p>`;
                } else {
                    llmExplanationContent.innerHTML = `<p class="text-red-300">Terjadi kesalahan saat mencoba menghasilkan penjelasan: ${error.message}</p>`;
                }
                console.error('Error fetching LLM explanation:', error);
            }
        }
    </script>
</body>
</html>
